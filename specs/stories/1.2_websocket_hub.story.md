# Story: WebSocket Hub & Connection

**Feature ID**: F02
**Story IDs**: S02.01 (Connection), S02.02 (Presence)
**Epic**: E01 - MVP
**Status**: DONE
**Owner**: Developer Agent
**Test Cases**: T02.01, T02.02, T02.03, T02.04

---

## User Story
**As a** logged-in user,
**I want to** establish a persistent WebSocket connection,
**So that** I can receive messages instantly.

---

## Requirements Covered
- [R04] Real-time message delivery.
- [R05] Multi-device support.

---

## Technical Context
*   **Library**: `github.com/gorilla/websocket`
*   **Auth**: Token passed via query param `?token=...`
*   **Hub Pattern**: Central registry `map[userID][]*websocket.Conn` (supports multi-device).

---

## Files to Create/Modify
| File | Action |
|------|--------|
| `internal/ws/hub.go` | CREATE - Hub struct, Register/Unregister |
| `internal/ws/client.go` | CREATE - Client struct, ReadPump, WritePump |
| `internal/handlers/ws_handler.go` | CREATE - Upgrade HTTP to WS |

---

## Connection Flow
1.  Client sends `GET /ws?token=JWT`.
2.  Server validates JWT (reuse auth logic).
3.  If valid, upgrade connection. Add to Hub.
4.  On disconnect, remove from Hub. Update `is_online` and `last_seen` in DB.

---

## Acceptance Criteria
- [x] **AC1** [T02.01]: Connection without token returns 401.
- [x] **AC2** [T02.02]: Valid token upgrades connection (101).
- [x] **AC3** [T02.03]: Server responds to Ping with Pong.
- [x] **AC4** [T02.04]: On disconnect, `last_seen` timestamp is updated.
