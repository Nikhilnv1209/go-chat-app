# Story: Read Receipts

**Feature ID**: F06
**Story IDs**: S06.01 (Create Receipt), S06.02 (Update Receipt Status), S06.03 (Query Receipt Status)
**Epic**: E01 - MVP
**Status**: DONE
**Owner**: Developer Agent
**Test Cases**: T06.01, T06.02, T06.03

---

## User Story
**As a** user,
**I want to** see if my message has been delivered and read,
**So that** I know the recipient has seen my message.

---

## Requirements Covered
- [R09] Message delivery confirmation (SENT → DELIVERED → READ)
- [R10] Receipt status queryable via API

---

## Technical Context
*   Leverages existing `MessageReceipt` model with statuses: `SENT`, `DELIVERED`, `READ`.
*   Requires `MessageReceiptRepository` implementation.
*   Updates occur via WebSocket events and REST endpoint.

---

## Files to Create/Modify
| File | Action |
|------|--------|
| `internal/repository/message_receipt_repo.go` | CREATE - Implement repository |
| `internal/service/message_service.go` | MODIFY - Inject receipt repo, create receipts on send |
| `internal/handlers/chat_handler.go` | MODIFY - Add `POST /messages/:id/read` endpoint |
| `internal/websocket/message_handler.go` | MODIFY - Handle `message_delivered` event |
| `cmd/server/main.go` | MODIFY - Wire up receipt repository |

---

## Event Flow

### 1. Message Send (Create Receipt)
1.  **Client**: Sends message via WebSocket
2.  **Server**:
    a.  Creates `Message` record
    b.  Creates `MessageReceipt` with `Status: SENT` for receiver
    c.  Broadcasts message to receiver
3.  **Result**: Receipt exists in DB with SENT status

### 2. Message Delivered (Update to DELIVERED)
1.  **Client** (Receiver): Receives message, sends `{ "type": "message_delivered", "payload": { "message_id": "uuid" } }`
2.  **Server**: Updates receipt status to `DELIVERED`
3.  **Server**: Broadcasts `receipt_update` event to sender

### 3. Message Read (Update to READ)
1.  **Client** (Receiver): User views message, calls `POST /messages/:id/read`
2.  **Server**: Updates receipt status to `READ`
3.  **Server**: Broadcasts `receipt_update` event to sender

---

## Database Schema (Existing)
```sql
CREATE TABLE message_receipts (
    id UUID PRIMARY KEY,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    message_id UUID NOT NULL REFERENCES messages(id),
    user_id UUID NOT NULL REFERENCES users(id),
    status VARCHAR(20) DEFAULT 'SENT', -- SENT, DELIVERED, READ
    INDEX idx_message_receipts_message_id (message_id),
    INDEX idx_message_receipts_user_id (user_id)
);
```

---

## API Endpoints

### Mark Message as Read
```
POST /messages/:id/read
Authorization: Bearer <JWT>

Response:
{
  "message_id": "uuid",
  "status": "READ",
  "read_at": "2025-12-11T00:30:00Z"
}
```

---

## WebSocket Events

### Outgoing: receipt_update
```json
{
  "type": "receipt_update",
  "payload": {
    "message_id": "uuid",
    "user_id": "uuid",
    "status": "READ",
    "updated_at": "2025-12-11T00:30:00Z"
  }
}
```

---

## Acceptance Criteria
- [x] **AC1** [T06.01]: When a message is sent, a receipt with status SENT is created.
- [x] **AC2** [T06.02]: When receiver's client acknowledges delivery, status updates to DELIVERED.
- [x] **AC3** [T06.03]: When receiver marks message as read, status updates to READ and sender is notified.
- [x] **AC4**: Receipt status is queryable via `GET /messages/:id/receipts`.

---

## Test Cases

### T06.01: Receipt Created on Send
**Given**: User A sends a message to User B
**When**: Message is saved to database
**Then**: A `MessageReceipt` record exists with `status=SENT` for User B

### T06.02: Receipt Updated to DELIVERED
**Given**: User B's client receives the message
**When**: Client sends `message_delivered` event
**Then**: Receipt status updates to `DELIVERED`

### T06.03: Receipt Updated to READ
**Given**: User B views the message
**When**: Client calls `POST /messages/:id/read`
**Then**: Receipt status updates to `READ` and User A receives `receipt_update` event
