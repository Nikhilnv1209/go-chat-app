# Story: Direct Messaging (One-on-One)

**Feature ID**: F03
**Story IDs**: S03.01 (Online DM), S03.02 (Offline DM), S03.03 (Conversation Sync)
**Epic**: E01 - MVP
**Status**: DONE
**Owner**: Developer Agent
**Test Cases**: T03.01, T03.02, T03.03

---

## User Story
**As a** user,
**I want to** send a text message to another user,
**So that** we can communicate privately.

---

## Requirements Covered
- [R04] Real-time message delivery.
- [R06] Message persistence.
- [R07] Unified MessageReceipt for DM & Group.

---

## Technical Context
*   Uses unified `MessageReceipt` model.
*   Updates `Conversation` table for both sender and receiver.

---

## Files to Create/Modify
| File | Action |
|------|--------|
| `internal/models/message.go` | CREATE |
| `internal/models/message_receipt.go` | CREATE |
| `internal/models/conversation.go` | CREATE |
| `internal/repository/message_repo.go` | CREATE |
| `internal/service/message_service.go` | CREATE |
| `internal/ws/message_handler.go` | CREATE - Handle incoming WS events |

---

## Event Flow (Send Message)
1.  **Client Event**: `{ "type": "send_message", "payload": { "to_user_id": 2, "content": "Hi" } }`
2.  **Server Actions**:
    a.  Insert into `messages` table.
    b.  Insert into `message_receipts` (ReceiverID, Status: SENT).
    c.  Upsert into `conversations` for Sender.
    d.  Upsert into `conversations` for Receiver (increment `unread_count`).
    e.  If Receiver is in Hub, push `new_message` event to their socket(s).
3.  **Server Response to Sender**: `{ "type": "message_sent", "payload": { "id": 505, "created_at": "..." } }`

---

## Acceptance Criteria
- [x] **AC1** [T03.01]: Online recipient receives message instantly.
- [x] **AC2** [T03.02]: Offline recipient has message saved in DB.
- [x] **AC3**: `Conversation.last_message_at` is updated.
- [x] **AC4**: `Conversation.unread_count` increments for receiver.
