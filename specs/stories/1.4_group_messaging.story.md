# Story: Group Management & Messaging

**Feature ID**: F04
**Story IDs**: S04.01 (Create Group), S04.02 (Group Message), S04.03 (Access Control)
**Epic**: E01 - MVP
**Status**: TODO
**Owner**: Developer Agent
**Test Cases**: T04.01, T04.02

---

## User Story
**As a** user,
**I want to** create a group and talk to multiple people,
**So that** we can coordinate together.

---

## Requirements Covered
- [R06] Message persistence.
- [R07] Unified MessageReceipt for DM & Group.

---

## Technical Context
*   Group creator becomes `ADMIN`.
*   Only members can send messages to the group.

---

## Files to Create/Modify
| File | Action |
|------|--------|
| `internal/models/group.go` | CREATE |
| `internal/models/group_member.go` | CREATE |
| `internal/repository/group_repo.go` | CREATE |
| `internal/service/group_service.go` | CREATE |
| `internal/handlers/group_handler.go` | CREATE - REST endpoints |

---

## API Contracts

### POST /groups
**Request**:
```json
{ "name": "Family", "member_ids": [2, 3] }
```
**Success (201)**:
```json
{ "id": 5, "name": "Family", "members": [...] }
```

---

## Event Flow (Send Group Message)
1.  **Client Event**: `{ "type": "send_message", "payload": { "group_id": 5, "content": "Hello Team" } }`
2.  **Server Actions**:
    a.  Verify sender is a member of Group 5.
    b.  Insert into `messages` table (with `group_id`).
    c.  For each member (except sender):
        *   Insert into `message_receipts`.
        *   Upsert into `conversations`.
        *   If in Hub, push `new_message` event.
3.  **Server Response to Sender**: `{ "type": "message_sent", "payload": { "id": 510 } }`

---

## Acceptance Criteria
- [ ] **AC1** [T04.01]: Non-member sending to group returns 403.
- [ ] **AC2** [T04.02]: All online group members receive the message.
- [ ] **AC3**: Group creator has role `ADMIN`.
