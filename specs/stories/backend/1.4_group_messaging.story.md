# Story: Group Management & Messaging

**Feature ID**: F04
**Story IDs**: S04.01 (Create), S04.02 (Msg), S04.03 (Access), S04.04 (Leave), S04.05 (Delete), S04.06 (Manage Members)
**Epic**: E01 - MVP
**Status**: IN_PROGRESS
**Owner**: Developer Agent
**Test Cases**: T04.01, T04.02

---

## User Story
**As a** user,
**I want to** create a group, manage members, and talk to multiple people,
**So that** we can coordinate together.

---

## Requirements Covered
- [R06] Message persistence.
- [R07] Unified MessageReceipt for DM & Group.

---

## Technical Context
*   Group creator becomes `ADMIN`.
*   Only members can send messages to the group.

---

## Files Created/Modified
| File | Status |
|------|--------|
| `internal/models/group.go` | ✅ CREATED |
| `internal/models/group_member.go` | ✅ CREATED |
| `internal/repository/group_repo.go` | ✅ CREATED |
| `internal/service/group_service.go` | ✅ CREATED |
| `internal/handlers/group_handler.go` | ✅ CREATED |
| `internal/service/message_service.go` | ✅ UPDATED |
| `internal/websocket/message_handler.go` | ✅ UPDATED |
| `cmd/server/main.go` | ✅ UPDATED |

---

## API Contracts

### POST /groups
**Request**:
```json
{ "name": "Family", "member_ids": [2, 3] }
```
**Success (201)**:
```json
{ "id": 5, "name": "Family", "members": [...] }
```

### GET /groups/:id
Returns group details and members.

### POST /groups/:id/members
**Request**: `{ "user_id": 99 }`
**Requirement**: Sender must be Admin.

### DELETE /groups/:id/members/:userId
**Requirement**: Sender must be Admin.

### DELETE /groups/:id/leave
**Requirement**: Any member can call.

### DELETE /groups/:id
**Requirement**: Sender must be Admin. Deletes group and all messages/members.

---

## Event Flow (Send Group Message)
1.  **Client Event**: `{ "type": "send_message", "payload": { "group_id": 5, "content": "Hello Team" } }`
2.  **Server Actions**:
    a.  Verify sender is a member of Group 5.
    b.  Insert into `messages` table (with `group_id`).
    c.  For each member (except sender):
        *   Insert into `message_receipts`.
        *   Upsert into `conversations`.
        *   If in Hub, push `new_message` event.
3.  **Server Response to Sender**: `{ "type": "message_sent", "payload": { "id": 510 } }`

---

## Acceptance Criteria
- [x] **AC1** [T04.01]: Non-member sending to group returns 403.
- [x] **AC2** [T04.02]: All online group members receive the message.
- [x] **AC3**: Group creator has role `ADMIN`.
- [ ] **AC4**: Admin can add members.
- [ ] **AC5**: Admin can remove members.
- [ ] **AC6**: User can leave group.
- [ ] **AC7**: Only Admin can delete group.

---

## Test Cases Implemented

### Service Layer Tests
- `TestGroupService_Create_Success` - Group creation with admin role
- `TestGroupService_Create_SkipsDuplicateCreator` - Duplicate handling
- `TestGroupService_AddMember_Success_AsAdmin` - Admin can add members
- `TestGroupService_AddMember_FailsForNonAdmin` - Non-admin rejection
- `TestGroupService_AddMember_FailsIfAlreadyMember` - Duplicate prevention
- `TestSendGroupMessage_Success` - Successful group message
- `TestSendGroupMessage_FailsForNonMember` - Non-member rejection (AC1)
- `TestSendGroupMessage_BroadcastsToAllMembers` - Broadcasting (AC2)
- `TestSendGroupMessage_UpdatesConversationForAllMembers` - Conversation updates
- `TestSendGroupMessage_SenderDoesNotReceiveOwnMessage` - Sender filtering

### Handler Layer Tests
- `TestCreateGroup_Success` - REST endpoint for group creation
- `TestCreateGroup_Unauthorized_NoToken` - Authentication check
- `TestCreateGroup_Unauthorized_InvalidToken` - Token validation
- `TestCreateGroup_BadRequest_MissingName` - Input validation
- `TestAddMember_Success` - REST endpoint for adding members
- `TestAddMember_Forbidden_NotAdmin` - Authorization check (AC3)
- `TestAddMember_BadRequest_InvalidGroupID` - UUID validation
- `TestAddMember_BadRequest_MissingUserID` - Required field validation

**Total**: 18 comprehensive tests covering all acceptance criteria
